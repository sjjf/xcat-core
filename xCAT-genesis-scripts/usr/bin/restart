#!/bin/bash
#
# IBM(c) 2007 EPL license http://www.eclipse.org/legal/epl-v10.html
#Redhcp, do the xcat part again
#
# Note that there's no guarantee that either the pid or lease files will still
# exist by the time we run, so where possible we use the `dynamic` flag from
# the ip(8) output to get a list of interfaces with dynamically allocated
# addresses.

log_label="xcat.genesis.restart"
FORCENICS=$(awk '{print $2}' </restart)
logger -s -t $log_label -p local4.info "Restarting network configuration. FORCENICS=$FORCENICS"
mapfile -t active_leases < <(find "$DHCLIENTDIR" -name 'dhclient.*.lease' 2>/dev/null)
mapfile -t dynamic_links < <(ip -4 -o a s scope global|grep dynamic|awk '{print $2}')
logger -s -t $log_label -p local4.info "Active leases found: ${active_leases[*]}"
logger -s -t $log_label -p local4.info "Dynamic links found: ${dynamic_links[*]}"

rm /restart
if [ -n "$FORCENICS" ]; then
    logger -s -t $log_label -p local4.info "Forcing down nics aside from $FORCENICS due to discoverynics setting"
    for NIC in "${dynamic_links[@]}"; do
        if [ -n "$NIC" ] && echo "$NIC" | grep -E -v "$FORCENICS"; then
            dhclient -r -1 \
                -cf /etc/dhclient.conf \
                -pf "$DHCLIENTRUNDIR/dhclient.$NIC.pid" \
                -lf "$DHCLIENTDIR/dhclient.$NIC.lease" \
                "$NIC"
            rm "$pidfile"
            ip link set "$NIC" down
        fi
    done
    dhclient6s=$(find "$DHCLIENTRUNDIR" -name 'dhclient6.*.pid' 2>/dev/null)
    for pidfile in $dhclient6s; do
        NIC=$(echo "$pidfile"|awk -F. '{print $2}')
        if [ -n "$NIC" ] && echo "$NIC" | grep -E -v "$FORCENICS"; then
            dhclient -6 -r -1 \
                -cf /etc/dhclient.conf \
                -pf "$pidfile" \
                -lf "$DHCLIENTDIR"/dhclient6.leases \
                "$NIC"
            rm "$pidfile"
            ip link set "$NIC" down
        fi
    done
fi
WAITING=1
mapfile -t dynamic_links < <(ip -4 -o a s scope global|grep dynamic|awk '{print $2}')
logger -s -t $log_label -p local4.info "Remaining dynamic links: ${dynamic_links[*]}"
while [ $WAITING -gt 0 ]; do
    logger -s -t $log_label -p local4.info "Renewing existing DHCP4 leases"
    mapfile -t dynamic_links < <(ip -4 -o a s scope global|grep dynamic|awk '{print $2}')
    for NIC in "${dynamic_links[@]}"; do
        logger -s -t $log_label -p local4.debug "Releasing $NIC"
        dhclient -r -1 \
            -cf /etc/dhclient.conf \
            -pf "$DHCLIENTRUNDIR/dhclient.$NIC.pid" \
            -lf "$DHCLIENTDIR/dhclient.$NIC.lease" \
            "$NIC"
        ip -4 addr flush dev "$NIC"
        logger -s -t $log_label -p local4.debug "Renewing $NIC"
        dhclient -nw \
            -cf /etc/dhclient.conf \
            -pf "$DHCLIENTRUNDIR/dhclient.$NIC.pid" \
            -lf "$DHCLIENTDIR/dhclient.$NIC.lease" \
            "$NIC"
    done
    logger -s -t $log_label -p local4.info "Renewing existing DHCP6 leases"
    dhclient6s=$(find "$DHCLIENTRUNDIR" -name 'dhclient6.*.pid' 2>/dev/null)
    for pidfile in $dhclient6s; do
        NIC=$(echo "$pidfile"|awk -F. '{print $2}')
        dhclient -6 -r -1 \
            -pf "$pidfile" \
            -lf "$DHCLIENTDIR/dhclient6.leases" \
            "$NIC"
        ip -6 addr flush dev "$NIC"  scope global
        ip -6 addr flush dev "$NIC"  scope site
        dhclient -6 -nw \
            -pf "$pidfile" \
            -lf "$DHCLIENTDIR/dhclient6.leases" \
            "$NIC"
    done

    echo -en "Waiting 10 seconds for DHCP changes to take effect          \r"
    for i in 9 8 7 6 5 4 3 2 1; do
       sleep 1
       echo -en "Waiting $i seconds for DHCP changes to take effect    \r"
    done

    # restart rsyslog after dhclient
    logger -s -t $log_label -p local4.info "Restarting rsyslogd"
    if [ -f /var/run/syslogd.pid ]; then
        kill -TERM "$(cat /var/run/syslogd.pid)"
    fi
    if [ -f /var/run/rsyslogd.pid ]; then
        kill -TERM "$(cat /var/run/rsyslogd.pid)"
    fi
    sleep 3

    RSYSLOGD_VERSION=$(rsyslogd -v | grep -m1 "rsyslogd" | tr -s ' ' | cut -d" " -f2 | cut -d"." -f1)
    if [ "$RSYSLOGD_VERSION" -ge 8 ]; then
        # Newer versions of rsyslogd do not support -c flag anymore
        /sbin/rsyslogd
    else
        /sbin/rsyslogd -c4
    fi

    WAITING=0
    if [ -n "$FORCENICS" ]; then
        for nic in $(ip -o link show |grep -i ether |awk -F ': ' '{print $2}'|grep -E "$FORCENICS"); do
            if ! ip -4 -o addr show "$nic"|grep -i inet > /dev/null; then
                WAITING=1
            fi
        done
        if [ $WAITING -gt 0 ]; then
        delay=30
        while [ $delay -gt 0 ]; do
            echo -en "Not all of the nics $FORCENICS managed to acquire an address, retrying in $delay seconds...    \r"
        done
        echo -e "                                                                                                                         \r"
        fi
    fi
done

echo "Done waiting                                                                                                                              ";
#/etc/init.d/S11stunnel #redo stunnel config
#exec /etc/init.d/S99xcat.sh
