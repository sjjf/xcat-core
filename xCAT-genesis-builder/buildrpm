# Build the xCAT-genesis-base rpm on a host system.
# Option 1:  install the xCAT-genesis-builder rpm (that includes this file) on a system installed with
#            the distro you want to use to build xCAT-genesis-base.
# Option 2:  untar the root file system of the distro you want to use and then chroot into it and copy
#            this whole dir into it somewhere (like /tmp).
# Then run this script.  The optional 1st arg should be mcp if you are building against mcp.

# Currently, *Fedora 28* and *RedHat 8* are the only OSes supported to build genesis-base for ppc64, and Centos 6.5 for x86_64

HOSTOS="$1"
DIR=`dirname $0`
#DIR=`realpath $DIR`
DIR=`readlink -f $DIR`
BUILDARCH=`uname -m`
REQUIRED_PACKAGES="vconfig rsyslog rpmdevtools rpm-build screen lldpad mstflint ipmitool pciutils mdadm dosfstools usbutils bind-utils psmisc nmap-ncat ethtool kexec-tools"

# Install required packages
pkglist=$(rpm -qa)
for required_package in $REQUIRED_PACKAGES; do
    if ! echo $pkglist |grep $required_package &>/dev/null; then
        yum -y install $required_package
        if [ $? -ne 0 ]; then
            echo "ERROR: Can not install required package $required_package, make sure EPEL repository is configured"
            exit 1
        fi
    else
        echo "$required_package already installed"
    fi
done

rpmdev-setuptree

#For Openpower
if [ -z $1 ]; then
    if [ $BUILDARCH = "ppc64le" ]; then
        HOSTOS="Pegas1.0"
        BUILDARCH="ppc64"
    elif [ $BUILDARCH = "ppc64" ]; then
        HOSTOS="fedora26"
    elif [ $BUILDARCH = "x86_64" ]; then
        yum install efibootmgr bc -y
        HOSTOS="centos7"
    fi
fi

# get the input files for dracut in the right place
# Fedora 20 ppc64 uses /usr/lib/dracut/modules.d
# CentOS 7 probably uses /usr/lib/dracut/modules.d also
if [ -e "/usr/share/dracut/modules.d" ]
then
    DRACUTMODDIR=/usr/share/dracut/modules.d/
else
    DRACUTMODDIR=/usr/lib/dracut/modules.d/
fi

cd $DIR
mkdir -p $DRACUTMODDIR/
cp -a 97xcat $DRACUTMODDIR
cp -a 96chrony $DRACUTMODDIR

mkdir -p /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/fs

# run dracut
if [ "$HOSTOS" = "mcp" ]; then
	KPATH=`/bin/ls -d /lib/modules/*`
	KERNELVERSION=`basename $KPATH`
	echo Creating the initramfs in /tmp/xcatgenesis.$$.rfs using dracut and kernel $KERNELVERSION ...
else
	echo Creating the initramfs in /tmp/xcatgenesis.$$.rfs using dracut ...
fi
# On Fedora 20 ppc64, dracut uses host-only mode by default
if [ $BUILDARCH = "ppc64" ]; then
    dracut -m "xcat" -N -f /tmp/xcatgenesis.$$.rfs $KERNELVERSION
else
    dracut -m "xcat" --no-early-microcode -N -f /tmp/xcatgenesis.$$.rfs $KERNELVERSION
fi

if [ $? -ne 0 ]; then
    echo "ERROR - creating the initramfs, please correct the issues and try again"
    exit 1
fi

echo Expanding the initramfs into /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/fs ...
cd /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/fs

zcat /tmp/xcatgenesis.$$.rfs|cpio -dumi

# add the perl library
# add /usr/share/ntp/lib for Fedora26 ppc64, the ntp-perl will installed libraries under it
PERL_LIB_DIR="/usr/share/perl5 /usr/lib64/perl5 /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/share/ntp/lib"
for d in `echo $PERL_LIB_DIR`; do
    if [ -e $d ]; then
        echo Adding perl libary "$d"
        TEMP_DIR=/tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/fs/"$d"
        mkdir -p $TEMP_DIR
        cp -a -t $TEMP_DIR $d/.
    fi
done

# create directory for ssh-keygen
mkdir -p /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/fs/etc/ssh

# add the kernel
if [ "$HOSTOS" = "mcp" ]; then
	echo Adding kernel /boot/vmlinuz-* ...
	cp /boot/vmlinuz-* /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/kernel
else
	echo Adding kernel /boot/vmlinuz-$BUILDARCH ...
	cp /boot/vmlinuz-`uname -r` /tmp/xcatgenesis.$$/opt/xcat/share/xcat/netboot/genesis/$BUILDARCH/kernel
fi
cd -

# create tar file
echo Tarring /tmp/xcatgenesis.$$/opt into ~/rpmbuild/SOURCES/xCAT-genesis-base-$BUILDARCH.tar.bz2 ...
cd /tmp/xcatgenesis.$$
tar jcf ~/rpmbuild/SOURCES/xCAT-genesis-base-$BUILDARCH.tar.bz2 opt

# build the rpm
echo Building xCAT-genesis-base rpm from ~/rpmbuild/SOURCES/xCAT-genesis-base-$BUILDARCH.tar.bz2 and $DIR/xCAT-genesis-base.spec ...
rpmbuild -ba $DIR/xCAT-genesis-base.spec
rm -rf $DRACUTMODDIR
